<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<title>Dashboard Docente</title>
	<link rel="stylesheet" href="/Pagina_web/CSS/docentestyles.css">
</head>
<body>
	<div class="container">
		<h1 id="docente-nombre">Bienvenido, Docente</h1>
		<h2>Materias Asignadas</h2>
		<ul id="materias-list"></ul>
		<div id="estudiantes-section" style="display:none;">
			<h2 id="materia-titulo"></h2>
			<form id="asistencia-notas-form">
				<input type="hidden" name="id_Oferta_Materia" id="id_Oferta_Materia">
				<table id="estudiantes-table">
					<thead>
						<tr>
							<th>Nombre</th>
							<th>Registro</th>
							<th>Asistencia</th>
							<th>Nota</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
				<button type="submit">Guardar Asistencia y Notas</button>
			</form>
			<button onclick="cerrarEstudiantes()">Cerrar</button>
		</div>
		<div id="mensaje"></div>
		<div id="debug" style="margin-top:2em; color:#444; font-size:0.98em;"></div>
	</div>
	<script>
	// URL de la API en Hostinger
	const API_BASE = "https://im-ventas-de-computadoras.com/Sistema_Academico/";

	// 1. Obtener email del docente desde localStorage
	const docenteEmail = localStorage.getItem("docente_email");
	if (!docenteEmail) {
		window.location.href = "login.html";
	}

	// 2. Consultar materias asignadas
	let materiasDocente = [];
	const debugDiv = document.getElementById("debug");
	debugDiv.innerHTML = `<b>Email usado:</b> ${docenteEmail}`;
	fetch(API_BASE + "get_materias_docente.php?email=" + encodeURIComponent(docenteEmail))
		.then(async r => {
			const text = await r.text();
			debugDiv.innerHTML += `<br><b>Respuesta cruda API:</b><br><pre style='background:#f4f4f4;padding:8px;border-radius:6px;'>${text.replace(/</g,'&lt;')}</pre>`;
			let data;
			try { data = JSON.parse(text); } catch { data = {}; }
			const ul = document.getElementById("materias-list");
			if (!data.ok || !data.materias || data.materias.length === 0) {
				ul.innerHTML = "<li style='color:#b00;font-weight:500;'>No tienes materias asignadas.</li>";
				document.getElementById("docente-nombre").textContent = `Bienvenido, Docente`;
				return;
			}
			document.getElementById("docente-nombre").textContent = `Bienvenido, ${data.docente.nombre} ${data.docente.apellido}`;
			ul.innerHTML = "";
			materiasDocente = data.materias;
			data.materias.forEach((m, idx) => {
				const li = document.createElement("li");
				li.innerHTML = `<div><b>${m.nombre}</b> <span style='color:#2a4d8f;'>(Código: ${m.codigo})</span> Grupo: <b>${m.grupo}</b></div><button data-idx='${idx}' class='btn-ver-estudiantes'>Ver estudiantes</button>`;
				ul.appendChild(li);
			});
		});

	// 3. Ver estudiantes de una materia
	// Delegación de eventos para los botones "Ver estudiantes"
	document.getElementById("materias-list").addEventListener("click", function(e) {
		if (e.target.classList.contains("btn-ver-estudiantes")) {
			const idx = e.target.getAttribute("data-idx");
			cargarEstudiantesMateria(idx);
		}
	});

	function cargarEstudiantesMateria(idx) {
		const materia = materiasDocente[idx];
		document.getElementById("materias-list").style.display = "none";
		document.getElementById("estudiantes-section").style.display = "block";
		document.getElementById("materia-titulo").textContent = `Estudiantes de ${materia.nombre} (${materia.codigo})`;
		document.getElementById("id_Oferta_Materia").value = materia.id_Oferta_Materia;
		// Si ya tenemos los estudiantes en el objeto, los usamos. Si no, los pedimos a la API (por si la API cambia)
		if (materia.estudiantes && materia.estudiantes.length > 0) {
			renderEstudiantes(materia.estudiantes);
		} else {
			// fallback: pedir a la API (puedes crear una API específica si lo deseas)
			fetch(API_BASE + "get_materias_docente.php?email=" + encodeURIComponent(docenteEmail))
				.then(r => r.json())
				.then(data => {
					if (data.ok && data.materias[idx] && data.materias[idx].estudiantes) {
						renderEstudiantes(data.materias[idx].estudiantes);
					} else {
						renderEstudiantes([]);
					}
				});
		}
	}

	function renderEstudiantes(estudiantes) {
		const tbody = document.querySelector("#estudiantes-table tbody");
		tbody.innerHTML = "";
		if (!estudiantes || estudiantes.length === 0) {
			tbody.innerHTML = `<tr><td colspan='4'>No hay estudiantes inscritos.</td></tr>`;
		} else {
			estudiantes.forEach(e => {
				const tr = document.createElement("tr");
				tr.innerHTML = `
					<td>${e.nombre} ${e.apellido}</td>
					<td>${e.nro_registro}</td>
					<td>
						<select name="asistencia[${e.id_Estudiante}]">
							<option value="Asistió">Asistió</option>
							<option value="Faltó">Faltó</option>
						</select>
					</td>
					<td>
						<input type="number" name="nota[${e.id_Estudiante}]" min="0" max="100">
					</td>
				`;
				tbody.appendChild(tr);
			});
		}
	}

	function cerrarEstudiantes() {
		document.getElementById("estudiantes-section").style.display = "none";
		document.getElementById("materias-list").style.display = "block";
		document.getElementById("mensaje").innerHTML = "";
	}

	// 4. Guardar asistencia y notas
	document.getElementById("asistencia-notas-form").addEventListener("submit", function(e) {
		e.preventDefault();
		const form = e.target;
		const formData = new FormData(form);
		fetch(API_BASE + "acciones_docente.php", {
			method: "POST",
			body: formData
		})
		.then(r => r.text())
		.then(resp => {
			document.getElementById("mensaje").innerHTML = resp;
		})
		.catch(() => {
			document.getElementById("mensaje").innerHTML = "<div style='color:red'>Error al guardar datos.</div>";
		});
	});
	</script>
</body>
</html>
