<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<title>Dashboard Docente</title>
	<link rel="stylesheet" href="/Pagina_web/CSS/docentestyles.css">
</head>
<body>
	<div class="container">
		<h1 id="docente-nombre">Bienvenido, Docente</h1>
		<h2>Materias Asignadas</h2>
		<ul id="materias-list"></ul>
		<div id="estudiantes-section" style="display:none;">
			<h2 id="materia-titulo"></h2>
			<form id="asistencia-form" style="margin-bottom:2em;">
				<input type="hidden" name="id_Oferta_Materia" id="id_Oferta_Materia_asistencia">
				<h3>Registrar Asistencia de Hoy</h3>
				<table id="asistencia-table" style="width:100%;max-width:500px;">
					<thead>
						<tr>
							<th>Nombre</th>
							<th>Registro</th>
							<th>Asistió</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
				<button type="submit">Guardar Asistencia</button>
			</form>
			<form id="notas-form" style="margin-top:2em;">
				<input type="hidden" name="id_Oferta_Materia" id="id_Oferta_Materia_nota">
				<h3>Registro de Notas</h3>
				<table id="notas-table">
					<thead>
						<tr>
							<th>Nombre</th>
							<th>Registro</th>
							<th>Nota</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
				<button type="submit">Guardar Notas</button>
			</form>
			<button onclick="cerrarEstudiantes()">Cerrar</button>
		</div>
		<div id="mensaje"></div>
	<!-- <div id="debug" style="margin-top:2em; color:#444; font-size:0.98em;"></div> -->
	</div>
	<script>
	// URL de la API en Hostinger
	const API_BASE = "https://im-ventas-de-computadoras.com/Sistema_Academico/";

	// 1. Obtener email del docente desde localStorage
	const docenteEmail = localStorage.getItem("docente_email");
	if (!docenteEmail) {
		window.location.href = "login.html";
	}

	// 2. Consultar materias asignadas
	let materiasDocente = [];
	// Leer id_docente de localStorage al cargar la página
	let docenteId = localStorage.getItem("docente_id") || '';
	// const debugDiv = document.getElementById("debug");
	// debugDiv.innerHTML = `<b>Email usado:</b> ${docenteEmail}<br><b>id_docente localStorage:</b> ${docenteId}`;
	fetch(API_BASE + "get_materias_docente.php?email=" + encodeURIComponent(docenteEmail))
		.then(async r => {
			const text = await r.text();
			// debugDiv.innerHTML += `<br><b>Respuesta cruda API:</b><br><pre style='background:#f4f4f4;padding:8px;border-radius:6px;'>${text.replace(/</g,'&lt;')}</pre>`;
			let data;
			try { data = JSON.parse(text); } catch { data = {}; }
			const ul = document.getElementById("materias-list");
			if (!data.ok || !data.materias || data.materias.length === 0) {
				ul.innerHTML = "<li style='color:#b00;font-weight:500;'>No tienes materias asignadas.</li>";
				document.getElementById("docente-nombre").textContent = `Bienvenido, Docente`;
				return;
			}
			document.getElementById("docente-nombre").textContent = `Bienvenido, ${data.docente.nombre} ${data.docente.apellido}`;
			ul.innerHTML = "";
			materiasDocente = data.materias;
			// Si el id_docente no estaba en localStorage, lo asignamos ahora
			if (!docenteId) {
				if (data.materias.length > 0 && data.materias[0].id_docente) {
					docenteId = data.materias[0].id_docente;
					localStorage.setItem("docente_id", docenteId);
				} else if (data.docente && data.docente.id_docente) {
					docenteId = data.docente.id_docente;
					localStorage.setItem("docente_id", docenteId);
				}
			}
			data.materias.forEach((m, idx) => {
				const li = document.createElement("li");
				li.innerHTML = `<div><b>${m.nombre}</b> <span style='color:#2a4d8f;'>(Código: ${m.codigo})</span> Grupo: <b>${m.grupo}</b></div><button data-idx='${idx}' class='btn-ver-estudiantes'>Ver estudiantes</button>`;
				ul.appendChild(li);
			});
		});

	// 3. Ver estudiantes de una materia
	// Delegación de eventos para los botones "Ver estudiantes"
	document.getElementById("materias-list").addEventListener("click", function(e) {
		if (e.target.classList.contains("btn-ver-estudiantes")) {
			const idx = e.target.getAttribute("data-idx");
			cargarEstudiantesMateria(idx);
		}
	});


	function cargarEstudiantesMateria(idx) {
		const materia = materiasDocente[idx];
		document.getElementById("materias-list").style.display = "none";
		document.getElementById("estudiantes-section").style.display = "block";
		document.getElementById("materia-titulo").textContent = `Estudiantes de ${materia.nombre} (${materia.codigo})`;
		// Detectar el nombre correcto del campo id de la materia
		let idOferta = materia.id_Oferta_Materia || materia.id_oferta_materia || materia.idOfertaMateria || '';
		const inputAsistencia = document.getElementById("id_Oferta_Materia_asistencia");
		const inputNota = document.getElementById("id_Oferta_Materia_nota");
		if (idOferta) {
			if (inputAsistencia) inputAsistencia.value = idOferta;
			if (inputNota) inputNota.value = idOferta;
		} else {
			if (inputAsistencia) inputAsistencia.value = '';
			if (inputNota) inputNota.value = '';
		}
		if (materia.estudiantes && materia.estudiantes.length > 0) {
			renderAsistencia(materia.estudiantes);
			renderNotas(materia.estudiantes);
		} else {
			fetch(API_BASE + "get_materias_docente.php?email=" + encodeURIComponent(docenteEmail))
				.then(r => r.json())
				.then(data => {
					if (data.ok && data.materias[idx] && data.materias[idx].estudiantes) {
						renderAsistencia(data.materias[idx].estudiantes);
						renderNotas(data.materias[idx].estudiantes);
					} else {
						renderAsistencia([]);
						renderNotas([]);
					}
				});
		}
	}


	// Genera planilla de asistencia para 30 días (puedes ajustar fechas dinámicamente)
	function renderAsistencia(estudiantes) {
		const tbody = document.querySelector("#asistencia-table tbody");
		tbody.innerHTML = "";
		if (!estudiantes || estudiantes.length === 0) {
			tbody.innerHTML = `<tr><td colspan='3'>No hay estudiantes inscritos.</td></tr>`;
		} else {
			estudiantes.forEach(e => {
				tbody.innerHTML += `
					<tr>
						<td>${e.nombre} ${e.apellido}</td>
						<td>${e.nro_registro}</td>
						<td style="text-align:center;">
						<input type="checkbox" name="asistencia" value="${e.id_Estudiante || e.id_estudiante || e.id || ''}">
						</td>
					</tr>
				`;
			});
		}
	}

	function renderNotas(estudiantes) {
		const tbody = document.querySelector("#notas-table tbody");
		tbody.innerHTML = "";
			if (!estudiantes || estudiantes.length === 0) {
				tbody.innerHTML = `<tr><td colspan='3'>No hay estudiantes inscritos.</td></tr>`;
			} else {
				estudiantes.forEach(e => {
					tbody.innerHTML += `
						<tr>
							<td>${e.nombre} ${e.apellido}</td>
							<td>${e.nro_registro}</td>
							<td><input type="number" name="nota_${e.id_Estudiante}" style="width:60px;" min="0" max="100" step="1"></td>
						</tr>
					`;
				});
			}
	}

	function cerrarEstudiantes() {
		document.getElementById("estudiantes-section").style.display = "none";
		document.getElementById("materias-list").style.display = "block";
		document.getElementById("mensaje").innerHTML = "";
	}


	// Guardar asistencia (planilla)

	document.getElementById("asistencia-form").addEventListener("submit", function(e) {
		e.preventDefault();
		const form = e.target;
		let errores = 0;
		const checkboxes = form.querySelectorAll("input[type='checkbox'][name='asistencia']:checked");
		const id_Oferta_Materia = document.getElementById("id_Oferta_Materia_asistencia").value;
		// Fecha local YYYY-MM-DD (sin hora, evita desfases por UTC)
		const now = new Date();
		const hoy = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
		let enviados = 0;
		let debugLog = '';
		if (form.querySelectorAll("input[type='checkbox'][name='asistencia']").length === 0) {
			document.getElementById("mensaje").innerHTML = '<div style="color:red">No hay estudiantes para registrar asistencia.</div>';
			return;
		}
		checkboxes.forEach(cb => {
			const id_Estudiante = cb.value;
			const payload = {
				id_Estudiante,
				id_Oferta_Materia,
				fecha: hoy
			};
			debugLog += `<pre style='background:#f4f4f4;padding:6px;border-radius:5px;'>Payload enviado: ${JSON.stringify(payload, null, 2)}</pre>`;
			fetch(API_BASE + "asignar_asistencia.php", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(payload)
			})
			.then(async r => {
				// Manejo robusto: algunos servidores devuelven cuerpo vacío o texto simple
				const statusOk = r.ok;
				const status = r.status;
				const statusText = r.statusText;
				const text = await r.text();
				let resp;
				try {
					resp = text ? JSON.parse(text) : { ok: statusOk };
				} catch (e) {
					const t = (text || '').trim().toLowerCase();
					const looksOk = statusOk || t === 'ok' || t === '1' || t === 'true' || t === 'success';
					resp = { ok: looksOk, raw: text };
				}
				debugLog += `<pre style='background:#f4f4f4;padding:6px;border-radius:5px;'>URL: ${API_BASE + 'asignar_asistencia.php'}\nHTTP: ${status} ${statusText}\nRespuesta cruda: ${text ? text.replace(/</g,'&lt;') : '(vacía)'}\nInterpretado: ${JSON.stringify(resp, null, 2)}</pre>`;
				// Tratar duplicados como idempotente (ya registrada)
				if (!resp.ok) {
					const dup = (resp && resp.error === 'PROC_ASISTENCIA' && /duplicate entry/i.test(resp.msg || ''));
					if (!dup) errores++;
				}
				enviados++;
				if (enviados === checkboxes.length) {
					mostrarMensajeAsistencia(errores);
					document.getElementById("mensaje").innerHTML += debugLog;
				}
			})
			.catch(err => {
				debugLog += `<pre style='background:#f4f4f4;padding:6px;border-radius:5px;'>Error: ${err}</pre>`;
				errores++;
				enviados++;
				if (enviados === checkboxes.length) {
					mostrarMensajeAsistencia(errores);
					document.getElementById("mensaje").innerHTML += debugLog;
				}
			});
		});
		// Si nadie fue marcado como presente
		if (checkboxes.length === 0) {
			document.getElementById("mensaje").innerHTML = '<div style="color:orange">No se marcó asistencia para ningún estudiante.</div>';
		}
	});

	function mostrarMensajeAsistencia(errores) {
		if (errores === 0) {
			document.getElementById("mensaje").innerHTML = '<div style="color:green">Asistencia guardada correctamente.</div>';
		} else {
			document.getElementById("mensaje").innerHTML = '<div style="color:red">Error al guardar algunas asistencias.</div>';
		}
	}

	// Guardar notas (formulario separado)

	document.getElementById("notas-form").addEventListener("submit", function(e) {
		e.preventDefault();
		const id_Oferta_Materia = document.getElementById("id_Oferta_Materia_nota") ? document.getElementById("id_Oferta_Materia_nota").value : '';
		const id_Docente = docenteId || '';
		const rows = document.querySelectorAll("#notas-table tbody tr");
		let resultados = [];
		let errores = 0;
		rows.forEach(row => {
			const nro_registro = row.children[1].textContent.trim();
			let nota = row.querySelector('input').value;
			nota = nota !== '' ? Number(nota) : '';
			const payload = {
				nro_registro,
				id_Oferta_Materia,
				valor: nota,
				id_Docente
			};
			fetch(API_BASE + "asignar_nota.php", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify(payload)
			})
			.then(async r => {
				const resp = await r.json();
				resultados.push({nro_registro, resp});
				if (!resp.ok) errores++;
				if (resultados.length === rows.length) {
					if (errores === 0) {
						document.getElementById("mensaje").innerHTML = '<div style="color:green">Notas guardadas correctamente.</div>';
					} else {
						document.getElementById("mensaje").innerHTML = '<div style="color:red">Error al guardar algunas notas.</div>';
					}
				}
			})
			.catch(() => {
				resultados.push({nro_registro, resp: 'error'});
				errores++;
				if (resultados.length === rows.length) {
					document.getElementById("mensaje").innerHTML = '<div style="color:red">Error al guardar algunas notas.</div>';
				}
			});
		});
	});
	</script>
</body>
</html>
