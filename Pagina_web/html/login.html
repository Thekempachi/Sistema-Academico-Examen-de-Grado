<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Login - Sistema Académico</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 420px; margin: 40px auto; }
    label { display:block; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; margin-top: 4px; }
    button { margin-top: 16px; padding: 10px; width: 100%; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Iniciar Sesión</h2>

  <form id="loginForm">
    <label for="rol">Ingresar como:</label>
    <select id="rol" name="rol" required>
      <option value="ESTUDIANTE">Estudiante</option>
      <option value="DOCENTE">Docente</option>
    </select>

    <label for="usuario" id="usuarioLabel">Nro. de registro</label>
    <input type="text" id="usuario" name="usuario" autocomplete="username" required>

    <label for="password">Contraseña</label>
    <input type="password" id="password" name="password" autocomplete="current-password" required>

    <button type="submit">Ingresar</button>
  </form>

  <script>
    const ENDPOINT = "https://im-ventas-de-computadoras.com/Sistema_Academico/login.php";
    const DEST = {
      DOCENTE: "/Pagina_web/html/docente.html",
      ESTUDIANTE: "/Pagina_web/html/estudiantes.html"
    };  

    const rolSel   = document.getElementById("rol");
    const usrLabel = document.getElementById("usuarioLabel");
    const usrInput = document.getElementById("usuario");

    // Cambia el placeholder/label según rol
    function updateUIForRole() {
      if (rolSel.value === "DOCENTE") {
        usrLabel.textContent = "Correo (email)";
        usrInput.placeholder  = "docente@ejemplo.edu";
        usrInput.type = "email";
      } else {
        usrLabel.textContent = "Nro. de registro";
        usrInput.placeholder  = "NR-XXXX";
        usrInput.type = "text";
      }
    }
    rolSel.addEventListener("change", updateUIForRole);
    updateUIForRole();

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const rol      = rolSel.value;
      const usuario  = usrInput.value.trim();
      const password = document.getElementById("password").value;

      const body = new URLSearchParams({ rol, usuario, password });

      try {
        const resp = await fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });

        const text = await resp.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { ok:false, error:"RESP_JSON_INVALIDA", raw:text }; }

        if (resp.ok && data.ok) {
          // Redirección según lo que devuelva el backend o el mapa local
          window.location.href = data.redirect || DEST[data.rol] || "/";
        } else if (resp.status === 401 || data.error === "CREDENCIALES_INVALIDAS") {
          alert("Usuario o contraseña incorrectos.");
        } else if (resp.status === 400 || data.error === "FALTAN_DATOS") {
          alert("Completa todos los campos.");
        } else if (resp.status === 403 || data.error === "ROL_NO_PERMITIDO") {
          alert("Solo se permite acceso a Docentes o Estudiantes.");
        } else {
          alert("⚠️ Error del servidor. Código: " + resp.status);
          console.error("Respuesta cruda:", text);
        }
      } catch (err) {
        alert("⚠️ Error de conexión (¿CORS/red?). Revisa la consola.");
        console.error(err);
      }
    });
  </script>
</body>
</html>
